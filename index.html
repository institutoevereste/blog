<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evereste TechNews</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827;
        }
        ::-webkit-scrollbar-thumb {
            background: #1e40af;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #1d4ed8;
        }
        .content-prose h1 { @apply text-4xl font-black mb-6 text-white; }
        .content-prose h2 { @apply text-3xl font-bold my-4 text-gray-100; }
        .content-prose h3 { @apply text-2xl font-bold my-4 text-gray-200; }
        .content-prose p { @apply mb-4 leading-relaxed text-lg text-justify text-gray-300; }
        .content-prose a { @apply text-teal-400 hover:underline; }
        .content-prose ul, .content-prose ol { @apply list-inside ml-4 mb-4 text-lg text-gray-300; }
        .content-prose li { @apply mb-2; }
        .content-prose blockquote { @apply border-l-4 border-gray-600 pl-4 italic text-gray-400; }
        
        #notification-toast {
            transition: opacity 0.5s, transform 0.5s;
        }

        #search-input {
            transition: width 0.3s ease-in-out;
        }
        .format-btn {
            @apply p-2 rounded transition-colors font-bold text-gray-200 w-8 h-8 flex items-center justify-center;
        }
        .format-btn:hover {
            @apply bg-gray-600;
        }
        .format-btn svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-200">

    <div id="app" class="min-h-screen">

        <!-- Header -->
        <header class="bg-blue-900/80 backdrop-blur-sm sticky top-0 z-50 shadow-lg">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                    <h1 class="text-2xl font-black text-white tracking-wider">EVERESTE TECHNEWS</h1>
                </div>
                <div class="flex items-center space-x-4">
                     <button id="admin-toggle-button" title="Painel Administrativo" class="p-2 rounded-full text-white hover:bg-teal-500/50 focus:outline-none">
                        <!-- Ícone é gerenciado via JS -->
                    </button>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="search-input" placeholder="Buscar matéria..." class="bg-gray-700 border border-gray-600 rounded-lg px-3 py-1 text-white focus:outline-none focus:ring-2 focus:ring-teal-500 w-0 hidden">
                        <button id="search-button" title="Buscar" class="p-2 rounded-full text-white hover:bg-teal-500/50 focus:outline-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Hero Banner -->
        <div id="hero-banner" class="w-full mb-8">
            <img src="https://i.postimg.cc/HxMK4LR8/CAPA-BLOG-EVERESTE-1.png" alt="Banner Evereste TechNews com o logo e o texto 'O Futuro é Agora'" class="w-full h-auto object-cover">
        </div>


        <main class="container mx-auto p-6 md:p-8 pt-0">
            
            <!-- Blog View -->
            <div id="blog-view">
                <div id="posts-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <p class="text-gray-500 col-span-full text-center">Carregando matérias...</p>
                </div>
            </div>
            
            <!-- Single Post View -->
            <div id="single-post-view" class="hidden">
                 <!-- Conteúdo do post será injetado aqui -->
            </div>


            <!-- Admin View -->
            <div id="admin-view" class="hidden">
                <div class="flex justify-between items-center mb-8 border-b-2 border-gray-700 pb-4">
                    <h2 class="text-3xl font-bold text-white flex items-center">
                        Painel Administrativo
                        <span id="db-status" class="ml-4 h-4 w-4 rounded-full bg-yellow-500 animate-pulse" title="Conectando..."></span>
                    </h2>
                    <button id="export-pdf-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                        <span>Exportar Relatório</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Coluna Esquerda: Editor -->
                    <div class="lg:col-span-2">
                         <div class="bg-gray-800 p-8 rounded-xl shadow-2xl">
                            <h3 class="text-2xl font-bold text-white mb-6">Editor de Matérias</h3>
                            <form id="post-form" class="space-y-6">
                                <input type="hidden" id="post-id">
                                <div>
                                    <label for="title" class="block text-sm font-medium text-gray-300 mb-1">Título da Matéria</label>
                                    <input type="text" id="title" placeholder="Ex: As novas tendências de IA para 2025" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                                </div>
                                <div>
                                    <label for="subtitle" class="block text-sm font-medium text-gray-300 mb-1">Subtítulo (Descrição Curta)</label>
                                    <input type="text" id="subtitle" placeholder="Um resumo atrativo que aparecerá na listagem do blog" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                                </div>
                                <div>
                                    <label for="imageUrl" class="block text-sm font-medium text-gray-300 mb-1">URL da Imagem de Capa</label>
                                    <input type="url" id="imageUrl" placeholder="Copie e cole o link de uma imagem online" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                                </div>
                                <div>
                                    <label for="content" class="block text-sm font-medium text-gray-300 mb-1">Conteúdo Completo</label>
                                     <!-- Barra de Formatação -->
                                    <div id="format-toolbar" class="flex items-center space-x-1 bg-gray-700 p-2 rounded-t-lg border-b border-gray-600 flex-wrap">
                                        <button type="button" class="format-btn" data-format="bold" title="Negrito"><b>B</b></button>
                                        <button type="button" class="format-btn" data-format="italic" title="Itálico"><i>I</i></button>
                                        <button type="button" class="format-btn" data-format="strikethrough" title="Tachado"><del>S</del></button>
                                        <div class="w-px h-5 bg-gray-600 mx-2"></div>
                                        <button type="button" class="format-btn" data-format="h2" title="Título">H2</button>
                                        <button type="button" class="format-btn" data-format="h3" title="Subtítulo">H3</button>
                                        <div class="w-px h-5 bg-gray-600 mx-2"></div>
                                        <button type="button" class="format-btn" data-format="link" title="Link"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" /></svg></button>
                                        <button type="button" class="format-btn" data-format="blockquote" title="Citação"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M6 3a1 1 0 00-1 1v1.586l-2.293-2.293a1 1 0 00-1.414 1.414L3.586 6H2a1 1 0 00-1 1v6a1 1 0 001 1h1.586l-2.293 2.293a1 1 0 101.414 1.414L6 14.414V16a1 1 0 001 1h6a1 1 0 001-1v-1.586l2.293 2.293a1 1 0 101.414-1.414L14.414 14H16a1 1 0 001-1V7a1 1 0 00-1-1h-1.586l2.293-2.293a1 1 0 10-1.414-1.414L14 4.586V4a1 1 0 00-1-1H7a1 1 0 00-1 1z" /></svg></button>
                                        <button type="button" class="format-btn" data-format="ul" title="Lista"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg></button>
                                        <button type="button" class="format-btn" data-format="ol" title="Lista Numerada">1.</button>
                                        <button type="button" class="format-btn" data-format="hr" title="Linha Horizontal"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5" /></svg></button>
                                        <div class="w-px h-5 bg-gray-600 mx-2"></div>
                                        <button type="button" class="format-btn" data-format="align-left" title="Alinhar à Esquerda"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25A.75.75 0 012.75 15h9.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg></button>
                                        <button type="button" class="format-btn" data-format="align-center" title="Centralizar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm3.25 5.25a.75.75 0 01.75-.75h9.5a.75.75 0 010 1.5h-9.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg></button>
                                        <button type="button" class="format-btn" data-format="align-right" title="Alinhar à Direita"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm6.25 5.25a.75.75 0 01.75-.75h9.5a.75.75 0 010 1.5h-9.5a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg></button>
                                        <button type="button" class="format-btn" data-format="align-justify" title="Justificar"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10zm0 5.25a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75a.75.75 0 01-.75-.75z" clip-rule="evenodd" /></svg></button>
                                    </div>
                                    <textarea id="content" rows="15" placeholder="Escreva sua matéria aqui. Use a barra acima para formatar." class="w-full bg-gray-700 border border-gray-600 rounded-b-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-teal-500" required></textarea>
                                </div>
                                <div class="flex justify-end space-x-4">
                                    <button type="button" id="cancel-edit-button" class="hidden bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700 transition duration-300">Cancelar</button>
                                    <button type="submit" id="submit-button" class="bg-teal-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-700 transition duration-300">Publicar Matéria</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- Coluna Direita: Dashboard e Gerenciamento -->
                    <div class="lg:col-span-1 space-y-8">
                        <div id="dashboard-container">
                            <h3 class="text-2xl font-bold text-white mb-4">Dashboard</h3>
                            <div class="space-y-6">
                                <!-- Gráfico de Matérias mais Lidas -->
                                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                    <h4 class="text-lg font-bold text-white mb-3">Top 5 Matérias Mais Lidas</h4>
                                    <div id="top-posts-chart-container">
                                        <canvas id="topPostsChart"></canvas>
                                    </div>
                                </div>
                                <!-- Gráfico de Canais de Compartilhamento -->
                                <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                                    <h4 class="text-lg font-bold text-white mb-3">Canais de Compartilhamento</h4>
                                    <div id="share-chart-container" class="max-w-xs mx-auto">
                                        <canvas id="shareChannelsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl">
                            <h3 class="text-2xl font-bold text-white mb-6">Gerenciar Matérias</h3>
                            <div id="admin-posts-list" class="space-y-4">
                                <!-- Lista de posts para gerenciar será injetada aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Notificação Toast -->
        <div id="notification-toast" class="fixed bottom-5 right-5 bg-teal-500 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transform translate-y-10 z-50">
            Mensagem da notificação
        </div>

        <!-- Modal de Confirmação para Exclusão -->
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
            <div class="bg-gray-800 rounded-lg shadow-2xl p-8 max-w-sm w-full">
                <h3 id="confirm-modal-title" class="text-xl font-bold text-white mb-4">Confirmar Exclusão</h3>
                <p id="confirm-modal-body" class="text-gray-300 mb-6">Tem certeza que deseja excluir esta matéria? Esta ação não pode ser desfeita.</p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-modal-cancel-btn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700">Cancelar</button>
                    <button id="confirm-modal-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Excluir</button>
                </div>
            </div>
        </div>

        <!-- Auth Modal -->
        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
            <div id="auth-container" class="bg-gray-800 rounded-lg shadow-2xl p-8 max-w-sm w-full">
                <!-- Conteúdo do Auth (Login) será injetado aqui -->
            </div>
        </div>
    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // =================================================================================
        // SUAS CHAVES DO FIREBASE.
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCDoi1FEGch-gUMP1n0UxL2u5sLvUmvFvo",
            authDomain: "blogevereste.firebaseapp.com",
            projectId: "blogevereste",
            storageBucket: "blogevereste.appspot.com",
            messagingSenderId: "1033247726137",
            appId: "1:1033247726137:web:ece19c7f318b8b790c4be8",
            measurementId: "G-L18FY3FZRY"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Elementos do DOM
        const postsContainer = document.getElementById('posts-container');
        const adminView = document.getElementById('admin-view');
        const blogView = document.getElementById('blog-view');
        const singlePostView = document.getElementById('single-post-view');
        const adminToggleButton = document.getElementById('admin-toggle-button');
        const postForm = document.getElementById('post-form');
        const adminPostsList = document.getElementById('admin-posts-list');
        const postIdInput = document.getElementById('post-id');
        const titleInput = document.getElementById('title');
        const subtitleInput = document.getElementById('subtitle');
        const imageUrlInput = document.getElementById('imageUrl');
        const contentInput = document.getElementById('content');
        const submitButton = document.getElementById('submit-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const notificationToast = document.getElementById('notification-toast');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
        const dbStatusIndicator = document.getElementById('db-status');
        const searchButton = document.getElementById('search-button');
        const searchInput = document.getElementById('search-input');
        const authModal = document.getElementById('auth-modal');
        const authContainer = document.getElementById('auth-container');
        const heroBanner = document.getElementById('hero-banner');
        const exportPdfButton = document.getElementById('export-pdf-button');
        
        let topPostsChartInstance = null;
        let shareChannelsChartInstance = null;
        let currentView = 'blog';
        let postsCollection;
        let allPosts = [];
        let isInitialLoad = true;
        
        // --- Funções de Status e Notificação ---
        function updateDbStatus(status) {
            if (!dbStatusIndicator) return;
            dbStatusIndicator.classList.remove('bg-yellow-500', 'bg-green-500', 'bg-red-500', 'animate-pulse');
            switch (status) {
                case 'connected': dbStatusIndicator.classList.add('bg-green-500'); dbStatusIndicator.title = 'Conectado'; break;
                case 'error': dbStatusIndicator.classList.add('bg-red-500'); dbStatusIndicator.title = 'Erro na conexão'; break;
                default: dbStatusIndicator.classList.add('bg-yellow-500', 'animate-pulse'); dbStatusIndicator.title = 'Conectando...';
            }
        }

        function showNotification(message, isError = false) {
            notificationToast.textContent = message;
            notificationToast.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg transition-all duration-300 opacity-100 transform-none ${isError ? 'bg-red-500' : 'bg-teal-500'}`;
            setTimeout(() => {
                notificationToast.className = notificationToast.className.replace('opacity-100 transform-none', 'opacity-0 translate-y-10');
            }, 5000);
        }

        // --- Autenticação e Inicialização ---
        onAuthStateChanged(auth, user => {
            updateAdminButtonIcon(user);
            if (user) {
                if (currentView !== 'admin') setView('admin');
                renderAdminList(allPosts);
                renderDashboard();
            } else {
                if (currentView === 'admin') setView('blog');
            }
        });

        // --- Funções de Login / Sessão ---
        function updateAdminButtonIcon(user) {
             if (user) {
                adminToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>`;
                adminToggleButton.title = "Sair";
            } else {
                adminToggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>`;
                adminToggleButton.title = "Painel Administrativo";
            }
        }
        
        adminToggleButton.addEventListener('click', async () => {
            if (auth.currentUser) {
                await signOut(auth);
                showNotification("Você saiu da sua conta.");
            } else {
                authContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-white mb-6 text-center">Acesso Administrativo</h3>
                    <form id="login-form" class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                            <input type="email" id="email" class="w-full bg-gray-100 text-gray-900 border border-gray-600 rounded-lg px-4 py-2" required>
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                            <input type="password" id="password" class="w-full bg-gray-100 text-gray-900 border border-gray-600 rounded-lg px-4 py-2" required>
                        </div>
                        <p id="auth-error" class="text-red-500 text-sm hidden"></p>
                        <div class="pt-2"><button type="submit" class="w-full bg-teal-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-teal-600">Entrar</button></div>
                    </form>`;
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                authModal.classList.remove('hidden');
            }
        });
        
        function handleLogin(e) {
            e.preventDefault();
            const email = e.target.email.value;
            const password = e.target.password.value;
            const errorEl = document.getElementById('auth-error');
            signInWithEmailAndPassword(auth, email, password)
                .then(() => {
                    authModal.classList.add('hidden');
                    errorEl.classList.add('hidden');
                })
                .catch(error => { 
                    errorEl.textContent = "Email não autorizado ou senha incorreta."; 
                    errorEl.classList.remove('hidden');
                });
        }
        
        authModal.addEventListener('click', e => { if (e.target === authModal) authModal.classList.add('hidden'); });

        // --- Gerenciamento de Views ---
        function setView(view, postId = null) {
            currentView = view;
            window.scrollTo({ top: 0 });
            [blogView, adminView, singlePostView].forEach(v => v.classList.add('hidden'));
            heroBanner.classList.remove('hidden');
            const updateHistory = (state, url) => { try { history.pushState(state, "", url); } catch (e) { /* silent fail */ } };
            if (view === 'blog') {
                blogView.classList.remove('hidden');
                updateHistory({view: 'blog'}, window.location.pathname);
            } else if (view === 'admin' && auth.currentUser) {
                adminView.classList.remove('hidden');
                updateHistory({view: 'admin'}, window.location.pathname);
                renderDashboard();
            } else if (view === 'single-post' && postId) {
                const post = allPosts.find(p => p.id === postId);
                if(post) {
                    renderSinglePost(post);
                    singlePostView.classList.remove('hidden');
                    heroBanner.classList.add('hidden');
                    updateHistory({view: 'single-post', postId}, `#${postId}`);
                } else {
                    setView('blog');
                }
            } else {
                setView('blog');
            }
        }

        // --- Funções de Renderização ---
        function calculateReadingTime(text) {
            if (!text) return "0 min de leitura";
            const wordsPerMinute = 200;
            const words = text.trim().split(/\s+/).length;
            const time = Math.ceil(words / wordsPerMinute);
            return time < 1 ? "Menos de 1 min" : `${time} min de leitura`;
        }

        function formatDate(timestamp) {
            if (!timestamp?.toDate) return '';
            return timestamp.toDate().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' });
        }
        
        function renderBlogPosts(posts) {
            postsContainer.innerHTML = '';
            if (posts.length === 0) {
                 postsContainer.innerHTML = `<p class="text-gray-500 col-span-full text-center">Nenhuma matéria encontrada.</p>`;
                return;
            }
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-gray-800 rounded-xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition duration-300 cursor-pointer flex flex-col';
                postElement.dataset.id = post.id;
                postElement.innerHTML = `
                    <img class="h-56 w-full object-cover" src="${post.imageUrl}" alt="" onerror="this.onerror=null;this.src='https://placehold.co/600x400/1e293b/d1d5db?text=Imagem';">
                    <div class="p-6 flex flex-col flex-grow">
                        <h2 class="text-2xl font-black text-teal-400 mb-2 flex-grow">${post.title}</h2>
                        <p class="text-gray-400 mb-4">${post.subtitle}</p>
                        <div class="text-sm text-gray-500 mt-auto pt-4 border-t border-gray-700">
                            <span>${formatDate(post.createdAt)}</span> &bull;
                            <span>${calculateReadingTime(post.content)}</span>
                        </div>
                    </div>
                `;
                postElement.addEventListener('click', () => setView('single-post', post.id));
                postsContainer.appendChild(postElement);
            });
        }
        
        function parseMarkdown(text = '') {
            const lines = text.split('\n');
            let html = '';
            let inUl = false, inOl = false;

            for (const line of lines) {
                if (!line.match(/^\s*(\*|\d+\.)\s+/)) {
                    if (inUl) { html += '</ul>\n'; inUl = false; }
                    if (inOl) { html += '</ol>\n'; inOl = false; }
                }

                if (line.match(/^##\s+(.*)/)) {
                    html += `<h2>${line.replace(/^##\s+/, '')}</h2>\n`;
                } else if (line.match(/^###\s+(.*)/)) {
                    html += `<h3>${line.replace(/^###\s+/, '')}</h3>\n`;
                } else if (line.match(/^\s*\*\s+(.*)/)) {
                    if (!inUl) { html += '<ul>\n'; inUl = true; }
                    html += `<li>${line.replace(/^\s*\*\s+/, '')}</li>\n`;
                } else if (line.match(/^\s*\d+\.\s+(.*)/)) {
                    if (!inOl) { html += '<ol>\n'; inOl = true; }
                    html += `<li>${line.replace(/^\s*\d+\.\s+/, '')}</li>\n`;
                } else if (line.match(/^\s*>\s+(.*)/)) {
                    html += `<blockquote>${line.replace(/^\s*>\s+/, '')}</blockquote>\n`;
                } else if (line.match(/^\s*---\s*$/)) {
                    html += '<hr class="my-8 border-gray-700">\n';
                } else if (line.trim() !== '') {
                    let p_tag = '<p>';
                    let content = line;
                    if (line.match(/^->\|<-\s+(.*)/)) {
                        p_tag = '<p style="text-align: center;">';
                        content = line.replace(/^->\|<-\s+/, '');
                    } else if (line.match(/^->\|\s+(.*)/)) {
                        p_tag = '<p style="text-align: right;">';
                        content = line.replace(/^->\|\s+/, '');
                    } else if (line.match(/^\|<-\s+(.*)/)) {
                        p_tag = '<p style="text-align: left;">';
                        content = line.replace(/^\|<-\s+/, '');
                    } else if (line.match(/^\|<->\|\s+(.*)/)) {
                         p_tag = '<p style="text-align: justify;">';
                        content = line.replace(/^\|<->\|\s+/, '');
                    }
                    html += `${p_tag}${content}</p>\n`;
                }
            }
            if (inUl) html += '</ul>\n';
            if (inOl) html += '</ol>\n';

            return html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                       .replace(/\*(.*?)\*/g, '<em>$1</em>')
                       .replace(/~~(.*?)~~/g, '<del>$1</del>')
                       .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        }

        function renderSinglePost(post) {
            singlePostView.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <button id="back-to-blog" class="mb-8 text-teal-400 hover:text-teal-500">&larr; Voltar para todas as matérias</button>
                    <img class="h-96 w-full object-cover rounded-xl mb-8" src="${post.imageUrl}" alt="" onerror="this.onerror=null;this.src='https://placehold.co/1200x600/1e293b/d1d5db?text=Imagem';">
                    <div class="flex justify-between items-center mb-4">
                         <div class="text-gray-400">
                            <span>Publicado em ${formatDate(post.createdAt)}</span> &bull;
                            <span>${calculateReadingTime(post.content)}</span>
                        </div>
                        <div class="relative">
                            <button id="share-toggle-button" title="Compartilhar" class="bg-gray-700 hover:bg-teal-500 text-white font-bold p-3 rounded-full transition duration-300">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                                </svg>
                            </button>
                            <div id="share-options" class="hidden absolute right-0 mt-2 w-48 bg-gray-700 rounded-lg shadow-xl z-20 overflow-hidden"></div>
                        </div>
                    </div>
                    <h1 class="text-5xl font-black text-white mb-4">${post.title}</h1>
                    <p class="text-xl text-gray-400 mb-8">${post.subtitle}</p>
                    <div class="prose max-w-none text-gray-300 content-prose">${parseMarkdown(post.content)}</div>
                </div>`;
            document.getElementById('back-to-blog').addEventListener('click', () => setView('blog'));
            setupShareButtons(post);
        }
        
        function renderAdminList(posts) {
            if (!adminPostsList) return;
            adminPostsList.innerHTML = '';
            posts.forEach(post => {
                const item = document.createElement('div');
                const isVisible = post.isVisible !== false;
                item.className = `bg-gray-700 p-4 rounded-lg flex justify-between items-center transition-opacity duration-300 ${isVisible ? 'opacity-100' : 'opacity-60'}`;
                item.innerHTML = `
                    <p class="text-white flex-1 truncate pr-4">${post.title}</p>
                    <div class="flex items-center space-x-4 flex-shrink-0">
                        <div class="flex items-center text-sm text-gray-400" title="Visualizações"><svg class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg><span>${post.viewCount || 0}</span></div>
                        <div class="flex items-center text-sm text-gray-400" title="Compartilhamentos"><svg class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg><span>${post.shareCount || 0}</span></div>
                        <div class="flex items-center space-x-2"><button data-id="${post.id}" data-visible="${isVisible}" class="toggle-visibility-btn p-2 rounded hover:bg-gray-600" title="${isVisible ? 'Ocultar' : 'Publicar'}">${isVisible ? `<svg class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>` : `<svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.414-1.414A10.004 10.004 0 00-1.172-1.172L3.707 2.293zm4.78 4.78a2 2 0 012.828 0l.001.001a2 2 0 11-2.829-2.828l-.001-.001zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /><path d="M10 3a10.004 10.004 0 00-7.293 3.293l1.414 1.414A8.005 8.005 0 0110 5c2.485 0 4.733 1.116 6.182 2.872l1.414-1.414A10.004 10.004 0 0010 3zM1.458 10c1.274 4.057 5.022 7 9.542 7 .848 0 1.673-.105 2.468-.305l-1.44-1.44a8.01 8.01 0 01-1.028.145c-4.418 0-7.98-2.686-9.08-6.195a8.004 8.004 0 012.336-5.111L1.458 10z" /></svg>`}</button><button data-id="${post.id}" class="edit-btn p-2 rounded bg-blue-600 text-white" title="Editar"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button data-id="${post.id}" class="delete-btn p-2 rounded bg-red-600 text-white" title="Excluir"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg></button></div>
                    </div>
                `;
                adminPostsList.appendChild(item);
            });
        }
        
        // --- Dashboard ---
        function renderDashboard() {
            if (!auth.currentUser) return;

            const textColor = '#d1d5db';
            const gridColor = 'rgba(255, 255, 255, 0.1)';

            // Top Posts Chart
            const topPosts = [...allPosts].sort((a,b) => (b.viewCount || 0) - (a.viewCount || 0)).slice(0, 5);
            const topPostsChartContainer = document.getElementById('top-posts-chart-container');

            if (topPostsChartContainer) {
                if (topPosts.length > 0 && topPosts.some(p => p.viewCount > 0)) {
                    topPostsChartContainer.innerHTML = '<canvas id="topPostsChart"></canvas>';
                    const topPostsCtx = document.getElementById('topPostsChart').getContext('2d');
                    if (topPostsChartInstance) topPostsChartInstance.destroy();
                    topPostsChartInstance = new Chart(topPostsCtx, {
                        type: 'bar',
                        data: {
                            labels: topPosts.map(p => p.title.substring(0, 20) + (p.title.length > 20 ? '...' : '')),
                            datasets: [{
                                label: 'Visualizações',
                                data: topPosts.map(p => p.viewCount || 0),
                                backgroundColor: '#14b8a6'
                            }]
                        },
                        options: {
                            indexAxis: 'y', responsive: true, plugins: { legend: { display: false } },
                            scales: {
                                y: { ticks: { color: textColor }, grid: { color: gridColor } },
                                x: { ticks: { color: textColor }, grid: { color: gridColor } }
                            }
                        }
                    });
                } else {
                     if (topPostsChartInstance) topPostsChartInstance.destroy();
                    topPostsChartContainer.innerHTML = '<p class="text-center text-gray-500 py-10">Nenhuma visualização registrada ainda.</p>';
                }
            }


            // Share Channels Chart
            const shareChannels = allPosts.reduce((acc, post) => {
                if(post.shareChannels) Object.entries(post.shareChannels).forEach(([k,v]) => acc[k] = (acc[k] || 0) + v);
                return acc;
            }, {});
            
            const shareChartContainer = document.getElementById('share-chart-container');
            if (shareChartContainer) {
                if (Object.keys(shareChannels).length > 0) {
                    shareChartContainer.innerHTML = '<canvas id="shareChannelsChart"></canvas>';
                    const shareChannelsCtx = document.getElementById('shareChannelsChart').getContext('2d');
                    if (shareChannelsChartInstance) shareChannelsChartInstance.destroy();
                    shareChannelsChartInstance = new Chart(shareChannelsCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(shareChannels).map(k => k.charAt(0).toUpperCase() + k.slice(1)),
                            datasets: [{
                                data: Object.values(shareChannels),
                                backgroundColor: ['#1d9bf0', '#1877f2', '#25d366', '#0a66c2', '#e4405f', '#7f8c8d'],
                                borderColor: '#1f2937'
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: { color: textColor }
                                }
                            }
                        }
                    });
                } else {
                    if (shareChannelsChartInstance) shareChannelsChartInstance.destroy();
                    shareChartContainer.innerHTML = '<p class="text-center text-gray-500 py-10">Nenhum compartilhamento registrado ainda.</p>';
                }
            }
        }


        function filterAndRenderPosts() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const visiblePosts = allPosts.filter(post => post.isVisible !== false);
            const postsToRender = searchTerm ? visiblePosts.filter(p => p.title.toLowerCase().includes(searchTerm) || p.subtitle.toLowerCase().includes(searchTerm)) : visiblePosts;
            renderBlogPosts(postsToRender);
        }
        
        async function initializeAppLogic() {
            updateDbStatus('connecting');
            postsCollection = collection(db, 'posts');
            onSnapshot(postsCollection, (snapshot) => {
                updateDbStatus('connected');
                allPosts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allPosts.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                
                filterAndRenderPosts();
                
                if (auth.currentUser) {
                    renderAdminList(allPosts);
                    renderDashboard();
                }

                if (isInitialLoad) {
                    handleUrlChange();
                    isInitialLoad = false;
                }
            }, (error) => {
                console.error("FIRESTORE READ ERROR:", error);
                updateDbStatus('error');
            });
        }
        initializeAppLogic();
        
        // --- Funções de Analytics ---
        async function incrementShareCount(postId, channel) {
            try {
                const postRef = doc(db, 'posts', postId);
                await updateDoc(postRef, {
                    [`shareChannels.${channel}`]: increment(1),
                    shareCount: increment(1)
                });
            } catch (error) { console.error("Error updating share count:", error); }
        }

        async function incrementViewCount(postId) {
            try {
                await updateDoc(doc(db, 'posts', postId), { viewCount: increment(1) });
            } catch (error) { console.error("Error updating view count:", error); }
        }
        
        // --- Modals de confirmação ---
        function showConfirmModal(onConfirm) {
            confirmModal.classList.remove('hidden');
            confirmModalConfirmBtn.onclick = () => { onConfirm(); hideConfirmModal(); };
        }
        function hideConfirmModal() { confirmModal.classList.add('hidden'); confirmModalConfirmBtn.onclick = null; }
        confirmModalCancelBtn.addEventListener('click', hideConfirmModal);
        confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) hideConfirmModal(); });
        
        // --- Navegação e Deep Link ---
        function handleUrlChange() {
            const postId = window.location.hash.substring(1);
            if(postId) {
                const post = allPosts.find(p => p.id === postId);
                if (post) {
                    setView('single-post', postId);
                    incrementViewCount(postId);
                } else {
                    setView('blog');
                }
            } else {
                setView('blog');
            }
        }
        window.addEventListener('popstate', handleUrlChange);

        // --- Lógica do Formulário e CRUD ---
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
             if(!auth.currentUser) {
                showNotification("Acesso negado. Faça o login para continuar.", true);
                return;
            }
            const id = postIdInput.value;
            const postData = { title: titleInput.value, subtitle: subtitleInput.value, imageUrl: imageUrlInput.value, content: contentInput.value };
            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';

            try {
                if (id) {
                    await updateDoc(doc(db, 'posts', id), postData);
                    showNotification('Matéria atualizada!');
                } else {
                    await addDoc(postsCollection, { 
                        ...postData, createdAt: serverTimestamp(), isVisible: true,
                        viewCount: 0, shareCount: 0, shareChannels: {}
                    });
                    showNotification('Matéria publicada!');
                }
                resetForm();
            } catch (error) {
                console.error("FIRESTORE WRITE ERROR:", error);
                showNotification("Erro ao salvar. Verifique as permissões do Firestore.", true);
            } finally {
                submitButton.disabled = false;
                resetForm();
            }
        });

        adminPostsList.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button || !auth.currentUser) return;
            const id = button.dataset.id;
            
             if (button.classList.contains('toggle-visibility-btn')) {
                const newVisibility = !(button.dataset.visible === 'true');
                try {
                    await updateDoc(doc(db, 'posts', id), { isVisible: newVisibility });
                    showNotification(`Matéria ${newVisibility ? 'visível' : 'ocultada'}.`);
                } catch (error) { showNotification('Erro ao atualizar.', true); }
            }
            
            if (button.classList.contains('delete-btn')) {
                showConfirmModal(async () => {
                    try {
                        await deleteDoc(doc(db, 'posts', id));
                        showNotification('Matéria excluída!');
                    } catch (error) { showNotification('Falha ao excluir.', true); }
                });
            }
            
            if (button.classList.contains('edit-btn')) {
                const postToEdit = allPosts.find(p => p.id === id);
                if (postToEdit) {
                    postIdInput.value = id;
                    titleInput.value = postToEdit.title;
                    subtitleInput.value = postToEdit.subtitle;
                    imageUrlInput.value = postToEdit.imageUrl;
                    contentInput.value = postToEdit.content;
                    submitButton.textContent = 'Atualizar Matéria';
                    cancelEditButton.classList.remove('hidden');
                    postForm.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });

        cancelEditButton.addEventListener('click', resetForm);

        function resetForm() {
            postForm.reset();
            postIdInput.value = '';
            submitButton.textContent = 'Publicar Matéria';
            cancelEditButton.classList.add('hidden');
        }

        // --- Lógica de Busca ---
        searchButton.addEventListener('click', () => {
            searchInput.classList.toggle('hidden');
            searchInput.classList.toggle('w-0');
            searchInput.classList.toggle('w-48');
            if (!searchInput.classList.contains('hidden')) searchInput.focus();
        });

        searchInput.addEventListener('input', () => {
            if (currentView !== 'blog') setView('blog');
            filterAndRenderPosts();
        });

        // --- Barra de Formatação ---
        document.getElementById('format-toolbar').addEventListener('click', (e) => {
            const btn = e.target.closest('.format-btn');
            if(!btn) return;

            const format = btn.dataset.format;
            const textarea = contentInput;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);

            if (format.startsWith('align')) {
                const markers = { 'align-left': '|<- ', 'align-center': '->|<- ', 'align-right': '->| ', 'align-justify': '|<->| ' };
                const prefix = markers[format];
                let lineStart = start;
                while (lineStart > 0 && textarea.value[lineStart - 1] !== '\n') { lineStart--; }
                let lineEnd = end;
                while (lineEnd < textarea.value.length && textarea.value[lineEnd] !== '\n') { lineEnd++; }
                const selectedLinesText = textarea.value.substring(lineStart, lineEnd);
                const newLines = selectedLinesText.split('\n').map(line => {
                    if (line.trim() === '') return line;
                    return prefix + line.replace(/^(\->\|<-\s|->\|\s|\|<-\s|\|<->\|\s)/, '');
                });
                textarea.setRangeText(newLines.join('\n'), lineStart, lineEnd, 'select');
                textarea.focus();
                return;
            }

            let prefix = '', suffix = '', replacement = selectedText;
            switch(format) {
                case 'bold': prefix = '**'; suffix = '**'; break;
                case 'italic': prefix = '*'; suffix = '*'; break;
                case 'strikethrough': prefix = '~~'; suffix = '~~'; break;
                case 'h2': prefix = '\n## '; suffix = '\n'; break;
                case 'h3': prefix = '\n### '; suffix = '\n'; break;
                case 'blockquote': prefix = '\n> '; suffix = '\n'; break;
                case 'ul': replacement = `\n* ${selectedText.replace(/\n/g, '\n* ')}\n`; break;
                case 'ol': replacement = `\n1. ${selectedText.replace(/\n/g, '\n1. ')}\n`; break;
                case 'hr': replacement = '\n---\n'; break;
                case 'link': 
                    const url = prompt("Insira a URL do link:");
                    if(url) { prefix = '['; suffix = `](${url})`; }
                    break;
            }
            if (prefix || suffix) { replacement = `${prefix}${selectedText}${suffix}`; }
            textarea.setRangeText(replacement, start, end, 'end');
            textarea.focus();
        });
        
        // --- Lógica de Compartilhamento ---
        function setupShareButtons(post) {
            const shareToggleButton = document.getElementById('share-toggle-button');
            const shareOptions = document.getElementById('share-options');
            if (!shareToggleButton || !shareOptions) return;

            const postUrl = `${window.location.origin}${window.location.pathname}#${post.id}`;
            const postTitle = post.title;

            shareOptions.innerHTML = `
                <a href="https://api.whatsapp.com/send?text=${encodeURIComponent(postTitle + ' - ' + postUrl)}" target="_blank" data-channel="whatsapp" rel="noopener noreferrer" class="share-link flex items-center w-full px-4 py-2 text-sm text-white hover:bg-gray-600">WhatsApp</a>
                <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(postUrl)}" target="_blank" data-channel="facebook" rel="noopener noreferrer" class="share-link flex items-center w-full px-4 py-2 text-sm text-white hover:bg-gray-600">Facebook</a>
                <a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(postUrl)}&text=${encodeURIComponent(postTitle)}" target="_blank" data-channel="twitter" rel="noopener noreferrer" class="share-link flex items-center w-full px-4 py-2 text-sm text-white hover:bg-gray-600">Twitter / X</a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(postUrl)}" target="_blank" data-channel="linkedin" rel="noopener noreferrer" class="share-link flex items-center w-full px-4 py-2 text-sm text-white hover:bg-gray-600">LinkedIn</a>
                <button data-channel="instagram" class="share-btn w-full text-left flex items-center px-4 py-2 text-sm text-white hover:bg-gray-600">Instagram</button>
                <button data-channel="copy" class="share-btn w-full text-left flex items-center px-4 py-2 text-sm text-white hover:bg-gray-600">Copiar Link</button>`;

            shareToggleButton.addEventListener('click', (e) => { e.stopPropagation(); shareOptions.classList.toggle('hidden'); });
            
            shareOptions.addEventListener('click', (e) => {
                const target = e.target.closest('.share-link, .share-btn');
                if (target) {
                    const channel = target.dataset.channel;
                    incrementShareCount(post.id, channel);
                    if(channel === 'instagram' || channel === 'copy') {
                        navigator.clipboard.writeText(postUrl).then(() => { 
                            const msg = channel === 'instagram' ? 'Link copiado! Cole no seu story ou post.' : 'Link da matéria copiado!';
                            showNotification(msg); 
                            shareOptions.classList.add('hidden'); 
                        });
                    }
                }
            });
        }
        
        document.addEventListener('click', (e) => {
            const shareOptions = document.getElementById('share-options');
            if (shareOptions && !shareOptions.classList.contains('hidden') && !shareOptions.contains(e.target) && !document.getElementById('share-toggle-button')?.contains(e.target)) {
                shareOptions.classList.add('hidden');
            }
        });

        // --- Lógica de Exportação para PDF ---
        exportPdfButton.addEventListener('click', () => {
            if(!allPosts.length) {
                showNotification("Não há dados para exportar.", true);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text("Relatório de Performance - Evereste TechNews", 10, 20);
            doc.setFontSize(12);
            doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 10, 28);

            const topPostsCanvas = document.getElementById('topPostsChart');
            const shareChannelsCanvas = document.getElementById('shareChannelsChart');
            
            doc.setFontSize(16);
            doc.text("Top 5 Matérias Mais Lidas", 10, 40);
            if (topPostsChartInstance) {
                 doc.addImage(topPostsCanvas.toDataURL('image/png', 1.0), 'PNG', 10, 45, 180, 90);
            }

            doc.text("Canais de Compartilhamento", 10, 150);
            if(shareChannelsChartInstance) {
                doc.addImage(shareChannelsCanvas.toDataURL('image/png', 1.0), 'PNG', 10, 155, 80, 80);
            }
            

            doc.addPage();
            doc.setFontSize(16);
            doc.text("Relatório Detalhado de Matérias", 10, 20);
            
            const tableData = allPosts.map(post => [
                post.title,
                post.viewCount || 0,
                post.shareCount || 0,
                post.isVisible !== false ? 'Visível' : 'Oculto'
            ]);

            doc.autoTable({
                startY: 30,
                head: [['Título', 'Visualizações', 'Compartilhamentos', 'Status']],
                body: tableData,
                headStyles: { fillColor: [22, 163, 74] },
            });

            doc.save(`relatorio-evereste-technews-${new Date().toISOString().slice(0,10)}.pdf`);
        });
        
    </script>
</body>
</html>

